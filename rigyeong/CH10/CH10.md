# 이벤트

## 10.1 시스템 간 강결합 문제
* 도메인 객체에 서비스 전달시 (강결합) ➡️ 이벤트로 해결.
	* 문제1) 외부 서비스 정상 아닐 경우 트랜잭션 처리 애매
	* 문제2) 성능
	* 문제3) 서로 다른 도메인 로직 섞임
## 10.2 이벤트 개요
* 이벤트 : 과거에 벌어진 어떤 것. 상태 변경 의미.
	* 발생시) 반응해 원하는 동작 수행하는 기능 구현
#### 10.2.1 이벤트 관련 구성 요소
![[Pasted image 20240403060502.png]]
* 이벤트 생성 주체 : 엔티티, 밸류, 도메인 서비스 같은 도메인 객체
	* 도메인 로직 실행시 상태 바뀌면 관련 이벤트 발생.
* 이벤트 핸들러 : 이벤트 생성 주체가 발생한 이벤트에 반응.
	* 이벤트에 담긴 데이터 이용해 원하는 기능 실행.
* 이벤트 디스패처 : 둘 연결. 구현 방식에 따라 이벤트 생성과 처리를 동기/비동기로 실행.

#### 10.2.2 이벤트의 구성
* 이벤트는 발생한 이벤트에 대한 정보(종류/발생시간/추가 데이터) 담음. 

#### 10.2.3 이벤트 용도
* 트리거
	* 도메인 상태 바뀔 때 다른 후처리 필요시 사용.
* 서로 다른 시스템 간의 데이터 동기화
	
#### 10.2.4 이벤트 장점
* 서로 다른 도메인 로직 섞이는 것 방지. 기능 확장 용이.

## 10.3 이벤트, 핸들러, 디스패처 구현

#### 10.3.1 이벤트 클래스
* 원하는 클래스를 이벤트로 사용. 과거 시제. 최소한 데이터 포함.
* 모든 이벤트가 공통으로 갖는 프로퍼티 존재시 관련 상위 클래스 생성. ex. 이벤트 발생 시간.

#### 10.3.2 Events 클래스와 ApplicationEventPublisher
* ApplicationEventPublisher : 이벤트 발생과 출판 위해 스프링 제공.
	* Event Publisher객체 : 전달할 이벤트 퍼블리셔를 스프링 설정 클래스통해.

#### 10.3.3 이벤트 발생과 이벤트 핸들러
* Events.raise() : 이벤트 발생
	* Event 타입 객체 전달.
* @EventListener : 이벤트 처리 핸들러 구현

![[Pasted image 20240403063930.png]]
* 도메인 상태 변경과 이벤트 핸들러는 같은 트랜잭션 범위에서 실행됨.

## 10.4 동기 이벤트 처리 문제
* 외부 서비스에 영향 받는 문제 
	* 외부 서비스의 성능 저하가 시스템 성능 저하로 연결. ex. 응용서비스에서 주문취소 -> 이벤트 핸들러에서 외부 환불 서비스 연동시
	* 트랜잭션 문제. ex. 외부 환불 서비스 실행 실패했다고 반드시 롤백해야하는가. 일단, 구매 취소 후 환불만 재처리. ➡️ 이벤트를 비동기로 처리 / 이벤트와 트랜잭션 연계

## 10.5 비동기 이벤트 처리
* 이벤트를 비동기로 처리 가능. A 이벤트 발생시 별도 스레드로 B 수행하는 핸들러 실행.
	ex. 회원가입시 이메일 검증, 주문취소와 결제취소

#### 10.5.1 로컬 핸들러 비동기 실행
* @Async 로 비동기로 이벤트 핸들러 실행.
#### 10.5.2 메시징 시스템 이용한 비동기 구현
* 카프카, 래빗MQ 사용
	* 이벤트 발생시 이벤트 디스패처가 이벤트를 메시지 큐에 보냄. -> 메시지큐는 이벤트를 메시지 리스너에 전달 -> 메시지 리스너는 알맞은 이벤트 핸들러 이용해 이벤트 처리.
![[Pasted image 20240403065203.png]]
* 글로벌 트랜잭션 사용시 ex. 래빗MQ
	* 장점 : 안전하게 이벤트를 메시지 큐에 전달
	* 단점 : 전체 성능 떨어짐
* 이벤트 발생 주체, 핸들러가 별도 프로세스에서 동작.

#### 10.5.3 이벤트 저장소를 이용한 비동기 처리
* 이벤트를 DB 저장 후 별도 프로그램 이용해 이벤트 핸들러에 전달
![[Pasted image 20240403065600.png]]
* 장점 : 핸들러 이벤트 처리 실패시 포워드는 다시 이벤트 저장소에서 이벤트 읽어와 실행.

* 포워더 대신 API 방식
	* 외부 핸들러가 API 서버 통해 이벤트 목록 가져감.
	* 이벤트 처리 추적 역할이 핸들러에 존재.

* 이벤트 저장소 구현
	![[Pasted image 20240403065933.png]]
	* EventStore : 이벤트 객체 직렬화해서 payload에 저장.

* REST API 구현
	* EventStore get해서 JSON 리턴. offset,limit

* 포워더 구현
	* 일정 주기로 EventStore에서 이벤트 읽어와 이벤트 핸들러에 전달.

## 10.6 이벤트 적용 시 추가 고려 사항
* 1. 이벤트 소스를 EventEntry 에 추가 여부
* 2. 포워더에서 전송 실패를 얼마나 허용할지
 - ex. 3회 실패시 해당 이벤트 생략
* 3. 이벤트 손실
 - 로컬 핸들러 이용해 비동기 처리시, 이벤트 처리 실패시 이벤트 유실
* 4. 이벤트 순서
 - 메시징 시스템 : 사용 기술에 따라 이벤트 발생 순서 다를 수 있음.
* 5. 이벤트 재처리
 - 마지막 처리 이벤트 순번 기억해두고, 이미 처리한 순번 이벤트 도착시 무시.
 - 멱등성 처리

#### 10.6.1 이벤트 처리와 DB 트랜잭션 고려

